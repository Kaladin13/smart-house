## Внутренний дизайн

***

### Основная цель - максимальная пропускная способность.

+ Для этой цели все процессы(корутины) логически разбиваются на 4 слоя, образуя конвеер:
    1. Poller - вынимает задачи пачками из очереди и публикует их для всех Consumer-ов
    2. Consumer - обходит всех Poller-ов и набирает свою(сбалансированно более маленькую) пачку задач (если задач
       слишком мало
       использует flush по истечению timeout-а)
    3. House - собственно сам дом. Принимает задачу от Consumer-ов и посывает отчёт на публикацию
    4. Publisher - набирает отчёты от домов в пачки и публикует их в другую очередь (если отчётов слишком мало -
       использует flush по истечению timeout-а)

    + Каждый слой общается с соседними при помощи Switch-ей, по сути представлящих обёртку над `List<Channel<T>>`
+ Конвеер адаптивный: в случае наличия большого числа запросов, они обрабатываюстя пачками, иначе - таймеры "
  проталкивают" дальше по нему, "что остаётся". Таймеры используют Exponential Backoff: в отсутсвии задач, сервис не
  нагружает систему.
+ Таким образом весь сервис выступает одним большим Pipe-ом между двумя Redis очередями.
  ![Picture](https://raw.githubusercontent.com/Kaladin13/smart-house/iot-dev/backend/iot/pipeline.svg)

### Метрики

Динамическое изменение RPS
![PicRPS](https://raw.githubusercontent.com/Kaladin13/smart-house/iot-dev/backend/iot/chartRPS.svg)

